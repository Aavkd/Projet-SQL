<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cIAra Mobility | Analytics Hub</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #1e1e2e;
            --light: #f8f9fa;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Sidebar & Layout */
        .wrapper { display: flex; width: 100%; }
        
        #sidebar {
            min-width: 260px;
            max-width: 260px;
            background: var(--dark);
            color: #fff;
            transition: all 0.3s;
            min-height: 100vh;
            position: fixed;
            z-index: 1000;
        }

        .sidebar-header { padding: 30px 20px; background: rgba(0,0,0,0.1); }
        .sidebar-header h3 { font-weight: 700; letter-spacing: 1px; }
        
        ul.components { padding: 20px 0; }
        ul.components li { padding: 5px 15px; }
        ul.components li a {
            padding: 15px;
            font-size: 1.1em;
            display: block;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 12px;
            transition: 0.3s;
        }
        ul.components li a:hover, ul.components li a.active {
            color: #fff;
            background: var(--primary);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            transform: translateX(5px);
        }
        ul.components li a i { margin-right: 10px; width: 25px; }

        /* Content Area */
        #content {
            width: 100%;
            margin-left: 260px;
            padding: 30px;
            transition: all 0.3s;
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
        }

        /* Stats Cards */
        .stat-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0; }
        .stat-label { color: #6c757d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Map */
        #map {
            height: 400px;
            border-radius: 15px;
            z-index: 1;
        }

        /* Table Modernization */
        .table-custom { border-collapse: separate; border-spacing: 0 10px; }
        .table-custom thead th { border: none; color: #6c757d; font-weight: 500; padding: 15px; }
        .table-custom tbody tr { 
            background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            transition: 0.2s;
        }
        .table-custom tbody tr:hover { transform: scale(1.01); z-index: 2; position: relative; }
        .table-custom td { border: none; padding: 20px 15px; vertical-align: middle; }
        .table-custom td:first-child { border-radius: 10px 0 0 10px; }
        .table-custom td:last-child { border-radius: 0 10px 10px 0; }

        /* Badges */
        .badge-soft { padding: 8px 12px; border-radius: 8px; font-weight: 500; }
        .badge-soft-success { background: rgba(76, 201, 240, 0.15); color: #0096c7; }
        .badge-soft-warning { background: rgba(255, 206, 86, 0.15); color: #d4a017; }
        .badge-soft-danger { background: rgba(247, 37, 133, 0.15); color: #c9184a; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }

        /* Mermaid Overrides */
        .mermaid-container { background: white; border-radius: 15px; padding: 20px; overflow-x: auto; }
        
        /* Mobile */
        @media (max-width: 768px) {
            #sidebar { margin-left: -260px; }
            #sidebar.active { margin-left: 0; }
            #content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-bolt me-2" style="color: var(--success);"></i>cIAra</h3>
            <small class="text-white-50">Mobility Database v1.0</small>
        </div>

        <ul class="list-unstyled components">
            <li><a href="#" class="active" onclick="switchTab('dashboard', this)"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="#" onclick="switchTab('fleet', this)"><i class="fas fa-car"></i> Flotte & Data</a></li>
            <li><a href="#" onclick="switchTab('map-view', this)"><i class="fas fa-map-marked-alt"></i> Carte Live</a></li>
            <li><a href="#" onclick="switchTab('schema', this)"><i class="fas fa-project-diagram"></i> Architecture</a></li>
            <li><a href="#" onclick="switchTab('docs', this)"><i class="fas fa-book"></i> Dictionnaire</a></li>
        </ul>
        
        <div class="mt-auto p-4">
            <div class="card bg-gradient-primary border-0 text-white p-3" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);">
                <small>Status DB</small>
                <div class="d-flex align-items-center mt-2">
                    <div class="spinner-grow spinner-grow-sm text-success me-2" role="status"></div>
                    <span>Connecté</span>
                </div>
            </div>
        </div>
    </nav>

    <div id="content">
        <nav class="navbar navbar-expand-lg navbar-light bg-transparent mb-4">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-light shadow-sm"><i class="fas fa-bars"></i></button>
                <h4 class="ms-3 mb-0 fw-bold" id="page-title">Vue d'ensemble</h4>
                <div class="ms-auto d-flex align-items-center">
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown">
                            <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="" width="40" height="40" class="rounded-circle shadow-sm">
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div id="dashboard" class="tab-section">
            <div class="row">
                <div class="col-md-3 mb-4 animate-in delay-1">
                    <div class="glass-card stat-card">
                        <div>
                            <h2 class="stat-value counter" data-target="189">0</h2>
                            <p class="stat-label">Véhicules</p>
                        </div>
                        <div class="stat-icon"><i class="fas fa-car-side"></i></div>
                    </div>
                </div>
                <div class="col-md-3 mb-4 animate-in delay-1">
                    <div class="glass-card stat-card">
                        <div>
                            <h2 class="stat-value counter" data-target="42">0</h2>
                            <p class="stat-label">En Location</p>
                        </div>
                        <div class="stat-icon" style="color: var(--success); background: rgba(76, 201, 240, 0.1);"><i class="fas fa-route"></i></div>
                    </div>
                </div>
                <div class="col-md-3 mb-4 animate-in delay-2">
                    <div class="glass-card stat-card">
                        <div>
                            <h2 class="stat-value counter" data-target="12">0</h2>
                            <p class="stat-label">Stations</p>
                        </div>
                        <div class="stat-icon" style="color: #f72585; background: rgba(247, 37, 133, 0.1);"><i class="fas fa-charging-station"></i></div>
                    </div>
                </div>
                <div class="col-md-3 mb-4 animate-in delay-2">
                    <div class="glass-card stat-card">
                        <div>
                            <h2 class="stat-value">98%</h2>
                            <p class="stat-label">Satisfaction</p>
                        </div>
                        <div class="stat-icon" style="color: #ffb703; background: rgba(255, 183, 3, 0.1);"><i class="fas fa-smile"></i></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4 animate-in delay-3">
                    <div class="glass-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold">Répartition par Ville</h5>
                            <span class="badge bg-primary">Live Data</span>
                        </div>
                        <canvas id="cityChart" height="120"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 mb-4 animate-in delay-3">
                    <div class="glass-card h-100">
                        <h5 class="fw-bold mb-4">État de la Flotte</h5>
                        <div style="position: relative; height: 200px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <small class="text-muted">Total des incidents: <span class="text-danger fw-bold">5</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fleet" class="tab-section" style="display: none;">
            <div class="glass-card animate-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold">Véhicules en Temps Réel</h5>
                    <div class="input-group w-25">
                        <span class="input-group-text bg-transparent border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Filtrer...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom" id="vehicleTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Modèle</th>
                                <th>Immatriculation</th>
                                <th>Autonomie</th>
                                <th>Ville</th>
                                <th>État</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="map-view" class="tab-section" style="display: none;">
            <div class="glass-card animate-in h-100">
                <h5 class="fw-bold mb-3">Localisation des Stations</h5>
                <div id="map"></div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="p-2 border rounded text-center">
                            <h5 class="mb-0 text-primary">30</h5>
                            <small>Bornes Paris</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2 border rounded text-center">
                            <h5 class="mb-0 text-success">25</h5>
                            <small>Bornes Lyon</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="schema" class="tab-section" style="display: none;">
            <div class="glass-card animate-in">
                <h5 class="fw-bold mb-3">Diagramme Entité-Relation (MCD)</h5>
                <div class="mermaid-container shadow-sm border">
                    <div class="mermaid">
                        erDiagram
                        TYPES_VEHICULES ||--o{ VEHICULES : categorise
                        STATIONS ||--o{ BORNES : possede
                        STATIONS ||--o{ VEHICULES : stationne
                        CLIENTS ||--o{ LOCATIONS : effectue
                        VEHICULES ||--o{ LOCATIONS : concerne
                        LOCATIONS ||--|| PAIEMENTS : genere
                        TECHNICIENS ||--o{ INTERVENTIONS : realise
                        VEHICULES ||--o{ INTERVENTIONS : subit
                        BORNES ||--o{ SESSIONS_RECHARGE : alimente
                        VEHICULES ||--o{ SESSIONS_RECHARGE : recharge
                    </div>
                </div>
            </div>
        </div>

        <div id="docs" class="tab-section" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="glass-card animate-in">
                        <h5 class="fw-bold">Tables</h5>
                        <div class="list-group list-group-flush">
                            <a href="#" class="list-group-item list-group-item-action bg-transparent border-0"><i class="fas fa-table me-2 text-primary"></i>VEHICULES</a>
                            <a href="#" class="list-group-item list-group-item-action bg-transparent border-0"><i class="fas fa-table me-2 text-primary"></i>STATIONS</a>
                            <a href="#" class="list-group-item list-group-item-action bg-transparent border-0"><i class="fas fa-table me-2 text-primary"></i>CLIENTS</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="glass-card animate-in">
                        <h5 class="fw-bold">Détails: VEHICULES</h5>
                        <p class="text-muted">Table principale gérant l'inventaire de la flotte.</p>
                        <table class="table table-sm">
                            <thead><tr><th>Champ</th><th>Type</th><th>Note</th></tr></thead>
                            <tbody>
                                <tr><td>id_vehicule</td><td>SERIAL</td><td>PK</td></tr>
                                <tr><td>marque</td><td>VARCHAR</td><td>Constructeur</td></tr>
                                <tr><td>etat</td><td>VARCHAR</td><td>Enum: Dispo, Maint...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>

<script>
    // --- 1. DATA SIMULATION (Based on User's CSV/SQL) ---
    const rawVehicles = [
        {id: 1, marque: "Kia", modele: "EV6", immat: "XR-964-LJ", auto: 320, etat: "En maintenance", ville: "Strasbourg"},
        {id: 2, marque: "Kia", modele: "EV6", immat: "OY-932-RY", auto: 270, etat: "En maintenance", ville: "Nantes"},
        {id: 3, marque: "Hyundai", modele: "Ioniq 5", immat: "BJ-663-FL", auto: 380, etat: "Hors service", ville: "Marseille"},
        {id: 8, marque: "Nissan", modele: "Leaf", immat: "SO-650-ZD", auto: 270, etat: "Disponible", ville: "Lyon"},
        {id: 10, marque: "Renault", modele: "Megane E-Tech", immat: "YE-951-QU", auto: 550, etat: "Disponible", ville: "Montpellier"},
        {id: 186, marque: "Tesla", modele: "Model Y", immat: "NN-119-YJ", auto: 290, etat: "Disponible", ville: "Nantes"},
        {id: 187, marque: "Volkswagen", modele: "ID.3", immat: "RV-850-FT", auto: 450, etat: "Hors service", ville: "Montpellier"},
        {id: 188, marque: "Peugeot", modele: "e-2008", immat: "UX-407-TO", auto: 310, etat: "Disponible", ville: "Nantes"},
        {id: 189, marque: "Volkswagen", modele: "ID.3", immat: "FZ-415-DG", auto: 540, etat: "Disponible", ville: "Paris"}, // Added for visual
        {id: 190, marque: "Tesla", modele: "Model 3", immat: "AA-123-BB", auto: 480, etat: "Loué", ville: "Paris"},
    ];

    const stations = [
        { name: 'Gare Paris Nord', lat: 48.8809, lng: 2.3553, city: 'Paris', cap: 30 },
        { name: 'Bellecour', lat: 45.7578, lng: 4.8320, city: 'Lyon', cap: 25 },
        { name: 'Vieux-Port', lat: 43.2951, lng: 5.3739, city: 'Marseille', cap: 20 },
        { name: 'Place de la Bourse', lat: 44.8404, lng: -0.5702, city: 'Bordeaux', cap: 15 }, // Inferred
        { name: 'Grand Place', lat: 50.6365, lng: 3.0635, city: 'Lille', cap: 18 } // Inferred
    ];

    // --- 2. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
        
        initCounters();
        initCharts();
        renderTable(rawVehicles);
        
        // Initialize Map only when tab is clicked to avoid rendering size issues
    });

    // --- 3. UI LOGIC ---
    let mapInitialized = false;

    function switchTab(tabId, element) {
        // Nav active state
        document.querySelectorAll('.components a').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // Hide all tabs
        document.querySelectorAll('.tab-section').forEach(sec => {
            sec.style.display = 'none';
            sec.classList.remove('animate-in'); // Reset animation
        });
        
        // Show target
        const target = document.getElementById(tabId);
        target.style.display = 'block';
        target.classList.add('animate-in');
        
        // Update Title
        const titles = {
            'dashboard': 'Vue d\'ensemble',
            'fleet': 'Gestion de Flotte',
            'map-view': 'Carte en Temps Réel',
            'schema': 'Architecture Base de Données',
            'docs': 'Documentation'
        };
        document.getElementById('page-title').innerText = titles[tabId];

        // Special Init for Map
        if (tabId === 'map-view' && !mapInitialized) {
            setTimeout(initMap, 100); // Small delay for layout to settle
        }
    }

    function initCounters() {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = +counter.getAttribute('data-target');
            const duration = 1500; 
            const increment = target / (duration / 16);
            
            let current = 0;
            const updateCount = () => {
                current += increment;
                if (current < target) {
                    counter.innerText = Math.ceil(current);
                    requestAnimationFrame(updateCount);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });
    }

    // --- 4. CHARTS (Chart.js) ---
    function initCharts() {
        // Status Chart
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Disponible', 'Maintenance', 'Hors Service', 'Loué'],
                datasets: [{
                    data: [65, 15, 5, 15],
                    backgroundColor: ['#4cc9f0', '#f72585', '#3f37c9', '#4361ee'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });

        // City Chart
        const ctxCity = document.getElementById('cityChart').getContext('2d');
        new Chart(ctxCity, {
            type: 'bar',
            data: {
                labels: ['Paris', 'Lyon', 'Marseille', 'Nantes', 'Lille'],
                datasets: [{
                    label: 'Véhicules',
                    data: [45, 30, 25, 20, 15],
                    backgroundColor: '#4361ee',
                    borderRadius: 5,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                scales: { 
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- 5. DATA TABLE & FILTER ---
    function renderTable(data) {
        const tbody = document.getElementById('vehicleTableBody');
        tbody.innerHTML = '';
        
        data.forEach(v => {
            let badgeClass = 'badge-soft-success';
            if (v.etat.includes('maintenance')) badgeClass = 'badge-soft-warning';
            if (v.etat.includes('Hors')) badgeClass = 'badge-soft-danger';
            
            const tr = `
                <tr>
                    <td class="fw-bold text-muted">#${v.id}</td>
                    <td><strong>${v.marque}</strong> <span class="text-muted">${v.modele}</span></td>
                    <td><span class="font-monospace bg-light p-1 rounded border">${v.immat}</span></td>
                    <td>${v.auto} km <i class="fas fa-battery-three-quarters text-success ms-1"></i></td>
                    <td>${v.ville}</td>
                    <td><span class="badge-soft ${badgeClass}">${v.etat}</span></td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    }

    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = rawVehicles.filter(v => 
            v.marque.toLowerCase().includes(term) || 
            v.modele.toLowerCase().includes(term) ||
            v.ville.toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

    // --- 6. MAP (Leaflet) ---
    function initMap() {
        const map = L.map('map').setView([46.603354, 1.888334], 6); // Center of France
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        stations.forEach(st => {
            L.marker([st.lat, st.lng])
                .addTo(map)
                .bindPopup(`<b>${st.name}</b><br>Capacité: ${st.cap} places`);
        });
        
        mapInitialized = true;
        
        // Force redraw to fix grey tiles issue in tabs
        setTimeout(() => map.invalidateSize(), 100);
    }

    // Toggle Sidebar
    document.getElementById('sidebarCollapse').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('active');
        // Handle CSS for mobile vs desktop logic here if needed
        const ml = document.getElementById('content').style.marginLeft;
        if(window.innerWidth > 768) {
            document.getElementById('content').style.marginLeft = ml === '0px' ? '260px' : '0px';
        }
    });

</script>
</body>
</html>